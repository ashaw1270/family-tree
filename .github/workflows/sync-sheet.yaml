name: Sync Google Sheet to JSON

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:       # Allows manual trigger from GitHub UI

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch and convert sheet data
        run: |
          python3 << 'EOF'
          import urllib.request, json, csv, io

          SHEET_ID = "2PACX-1vQmJlun6fT1zQynJG_395ufU3s7eWj1zmQ9ZpK6wKXdEbGGRJDWeKo0TlTYNzxEmbq5eHFXDekY8eE6"
          LIST_FIELDS = {"bigs", "littles"}  # columns to treat as comma-delimited lists

          def fetch_sheet(sheet_name):
            url = f"https://docs.google.com/spreadsheets/d/{SHEET_ID}/gviz/tq?tqx=out:csv&sheet={sheet_name}"
            req = urllib.request.Request(url, headers={"User-Agent": "Mozilla/5.0"})
            with urllib.request.urlopen(req) as response:
                raw = response.read().decode('utf-8')
            reader = csv.DictReader(io.StringIO(raw))
            rows = []
            for row in reader:
                obj = {}
                for key, value in row.items():
                    if key in LIST_FIELDS and isinstance(value, str):
                        value = [s.strip() for s in value.split(',') if s.strip()]
                    obj[key] = value
                rows.append(obj)
            return rows

          output = {
              "people": fetch_sheet("people"),
              "pledgeClasses": fetch_sheet("pledgeClasses"),
              "families": fetch_sheet("families"),
          }

          with open('dataa.json', 'w') as f:
              json.dump(output, f, indent=2)

          print("Done.")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data/site-data.json
          git diff --staged --quiet || git commit -m "Sync data from Google Sheet"
          git push
