name: Sync Google Sheet to JSON

on:
  schedule:
    - cron: '0 * * * *'  # Runs every hour
  workflow_dispatch:       # Allows manual trigger from GitHub UI

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Fetch and convert sheet data
        run: |
          python3 << 'EOF'
          import urllib.request, json, csv, io

          SHEET_ID = "2PACX-1vQmJlun6fT1zQynJG_395ufU3s7eWj1zmQ9ZpK6wKXdEbGGRJDWeKo0TlTYNzxEmbq5eHFXDekY8eE6"
          LIST_FIELDS = {"bigs", "littles", "family"}  # columns to treat as comma-delimited lists

          def fetch_sheet(sheet_name):
              gid_dict = {
                  "people": 0,
                  "pledgeClasses": 941699657,
                  "families": 770554282
              }
              gid = gid_dict[sheet_name]
          
              url = f"https://docs.google.com/spreadsheets/d/e/{SHEET_ID}/pub?output=csv&gid={gid}"
              req = urllib.request.Request(url, headers={"User-Agent": "Mozilla/5.0"})
              with urllib.request.urlopen(req) as response:
                  raw = response.read().decode('utf-8')

              first_row = {
                  "people": 3,
                  "pledgeClasses": 2,
                  "families": 0
              }
              first_row_num = first_row[sheet_name]
                  
              reader = csv.DictReader(io.StringIO(raw))
              rows = []
              for row in list(reader)[first_row_num:]:  # exclude examples
                  obj = {}
                  for key, value in row.items():
                      if key in LIST_FIELDS and isinstance(value, str):
                          value = [s.strip() for s in value.split(',') if s.strip()]
                      obj[key] = value
                      
                  name = list(obj.values())[0]
                  if name == "":
                      continue

                  if "nickname" in obj and obj["nickname"] == "":
                      del obj["nickname"]

                  if "family" in obj:
                      family = obj["family"]
                      del obj["family"]
                      obj["families"] = family

                  if "redacted?" in obj:
                      redacted = (obj["redacted?"] != "")
                      del obj["redacted?"]
                      if redacted:
                          obj["redacted"] = True
                      
                  rows.append(obj)
              return rows

          output = {
              "people": fetch_sheet("people"),
              "pledgeClasses": fetch_sheet("pledgeClasses"),
              "families": fetch_sheet("families"),
          }

          with open('data.json', 'w') as f:
              json.dump(output, f, indent=2)

          print("Done.")
          EOF

      - name: Commit and push if changed
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git diff --staged --quiet || git commit -m "Sync data from Google Sheet"
          git push
